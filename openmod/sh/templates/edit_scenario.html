{% extends "base_layout.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdn.plot.ly/plotly-1.23.1.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket-leaflet.js"></script>
{% endblock %}

{% block header %}

<div style="float:left; width:50%;">
 Selected scenario: {{ scenario.get('name', 'NONE') }}
</div>
<div align="right", id="boxlink", style="float:left; width:25%;"
     onclick="updateScenario(scenario)">
 <a href="javascript:void(0)">Update scenario</a>
</div>
<div align="right", id="boxlink", style="float:right; width:25%;"
     onclick="saveNewScenario(scenario)">
 <a href="javascript:void(0)">Save New</a>
</div>

{% endblock %}

{% block body %}

<div style="float:left; width:35%;">

<div id="slider_table">
<h3>Select values</h3>
 <table style="width:50%">
  <caption>Kiel</caption>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td>{{_("Area Usage")}}</td>
  </tr>
  <tr>
    <td>{{_("Solar Roof")}}</td>
    <td>
        <input id="installed_power_solar_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('installed_power_solar', this.value)" /></td>
    <td>
        <span id="installed_power_solar_display">0</span>
    </td>
    <td>
        <span id="installed_power_solar_area">0</span>
    </td>
  </tr>
  <tr>
    <td>{{_("Solar Rural")}}</td>
    <td>
        <input id="solar_rural_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('solar_rural', this.value)" /></td>
    <td>
        <span id="solar_rural_display">0</span>
    </td>
    <td>
        <span id="solar_rural_area">0</span>
    </td>
  </tr>
  <tr>
    <td>{{_("Wind")}}</td>
    <td>
        <input id="installed_power_wind_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('installed_power_wind', this.value)" />
    </td>
    <td>
        <span id="installed_power_wind_display">0</span>
    </td>
    <td>
        <span id="installed_power_wind_area">0</span>
    </td>
   </tr>
   <tr>
    <td>{{_("Biomass CHP")}}</td>
    <td>
        <input id="biomass_chp_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('biomass_chp', this.value)" />
    </td>
    <td>
        <span id="biomass_chp_display">0</span>
    </td>
    <td>
        <span id="biomass_chp_area">0</span>
    </td>
  </tr>
</table>
</div>

<div>
<form action="{{ url_for('show_scenarios') }}"
      method=get>
<input type=submit value="Go to scenario overview">
</form>

<button type="button" onclick="runSimulation(scenario)">Run Simulation</button>
</div>
</div>


<div style="float:right; width:65%;">
 <div class="tab">
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab1')" id="defaultOpen">Region Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab2')">Timeseries Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab3')">Heatmap Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab4');updateResults('kiel_electricity')">Production</a>
 </div>

 <div id="Tab1" class="tabcontent">
  <div id="region_plot"></div>
 </div>

 <div id="Tab2" class="tabcontent">
  <div id="timeseries_plot" style="height 300px;"></div>
  <button type="button" onclick="reorderTimeseries()">Reorder</button>
 </div>


 <div id="Tab3" class="tabcontent">
  <div id="heatmap_plot"></div>
 </div>

 <div id="Tab4" class="tabcontent">
  <div id="bar_plot", style="height 300px;"> </div>
  <button type="button" onclick="updateResults('kiel_electricity')">Kiel</button>
  <button type="button" onclick="updateResults('nms_electricity')">Neumünster</button>
  <button type="button" onclick="updateResults('ploe_electricity')">Plön</button>
  <button type="button" onclick="updateResults('rdeck_electricity')">Rendsburg Eck</button>
  <button type="button" onclick="updateResults('kiel_heat')">Kiel Wärme</button>
 </div>


</div>

{% endblock %}

{% block footer %}
<script src="static/plots.js"></script>

<script type="text/javascript">
function updateValue(slider_id, newValue) {
    document.getElementById(slider_id + "_slider").value = newValue;
    document.getElementById(slider_id + "_display").innerHTML = newValue;
    document.getElementById(slider_id + "_area").innerHTML = newValue * 10;
    var l = lookup[slider_id];
    scenario.children_dict[l.child].tags[l.tag] = newValue;
    makeTimeseriesPlot();
    makeRegionPlot();
    makeHeatmapPlot();
}

function updateResults(hub_name) {
    makeBarPlot(hub_name=hub_name);
}

var timeseriesOrder = false;

// JQUERY TO START NEW MODEL RUN (Send json)
function runSimulation(scenario) {
        return $.ajax({
            url: 'simulate',
            type: 'put',
            data: JSON.stringify(scenario),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            complete: function() {
                alert('Starting new model run to calculate results!');}
        })
    }


// GET RESULTS FUNCTION FOR AGGREGATE RESULTS
function getResults(scenario_db_id, hub_name, callback) {
    return $.ajax({
        url: 'API/results/aggregated',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                hub_name: hub_name}
        })
    .done(callback)
    }

function saveNewScenario(scenario) {
    scenario['name'] = prompt("New name", scenario['name']);
    scenario['tags']['description'] = prompt("New description", scenario['tags']['description']);
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Saved successfully! Opening new scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            alert("Scenario name is already taken. Try again.");
            saveNewScenario(scenario);
        }
    });
   // ALWAYS START A NEW SIMULATION IF THE THE SCENARIO IS SAVED
   runSimulation(scenario)
}

function updateScenario(scenario) {
    // Delete existing scenario
    $.get('delete', {
        id: scenario_db_id
    });
    // Update scenario children from dict which is manipulated by slider
    scenario.children = Object.values(scenario.children_dict);
    // Use element API to write to DB
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Updated successfully! Opening updated scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            alert("Error. This should not have happened. Call somebody.");
        }
    });
   // ALWAYS START A NEW SIMULATION IF THE THE SCENARIO IS SAVED
   runSimulation(scenario)
}

function makeSlider(lookup) {
    for (var key in lookup) {
        var value = lookup[key];
    }
    $('#slider_table').append('<tr><td>test</td></tr>');
}


// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();

var scenario_db_id = {{ scenario_db_id }};

var scenario = {{ scenario | tojson }};

scenario.children_dict = {};
scenario.children.forEach(function(data) {
    scenario.children_dict[data.name] = data
});

lookup = {
    installed_power_solar: {
        child: "kiel_solar",
        tag: "installed_power",
        pos: [54.3, 10.1],
        color: 'orange'
    },
    installed_power_wind: {
        child: "kiel_wind",
        tag: "installed_power",
        pos: [54.3, 10.15],
        color: 'darkblue'
    }
};

makeSlider(lookup);

updateValue("installed_power_solar", 12);
updateValue("installed_power_wind", 2);
</script>
{% endblock %}
