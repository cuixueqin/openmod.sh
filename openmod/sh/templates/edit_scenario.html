{% extends "base_layout.html" %}

{% block head %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.plot.ly/plotly-1.23.1.min.js"></script>
<link rel="stylesheet" href="/static/jquery-ui.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket-leaflet.js"></script>
{% endblock %}

{% block submenu %}

<li class="nav-item">
<a class="nav-link" href="#">Selected scenario: {{ scenario.get('name', 'NONE') }}</a>
</li>

<li class="nav-item" onclick="updateScenario(scenario)">
<a class="nav-link" href="javascript:void(0)">Update scenario</a>
</li>

<li class="nav-item" onclick="saveNewScenario(scenario)">
<a class="nav-link" href="javascript:void(0)">Save New</a>
</li>

<li class="nav-item" onclick="runSimulation(scenario)">
<a class="nav-link" href="javascript:void(0)">Run Simulation</a>
</li>

{% endblock %}


{% block content %}
<!-- interface -->
<div class="row no-gutters tool">
    <div class="col-4">
        <header>
            Parameter
        </header>
        <div class="toolbar"><br/></div>
        <div class="body">
            <form id="slider_form"></form>
        </div>
    </div>
    <div class="col">
        <ul class="nav nav-tabs" id="plot_tab"></ul>
        <div class="tab-content" id="plot_tab_content"></div>
    </div>
</div>

<script src="/static/jquery-ui.min.js"></script>

<script src="static/plots.js"></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="static/helper.js"></script>

<script type="text/javascript">
function makeTab(id, label, options, content, onclick="", active="") {
    $('#plot_tab').append(
        '<li class="nav-item" onclick="'+onclick+'">'
        +'<a class="nav-link '+active+'" data-toggle="tab" href="#'+id+'_tab">'+label+'</a>'
        +'</li>');
    $('#plot_tab_content').append(
        '<div class="tab-pane '+active+'" id="'+id+'_tab" role="tabpanel">'
        +'<div class="toolbar">'+options+'</br></div>'
        +'<div id="'+id+'"></div>'
        +content
        +'</div>');
}

function tracePredecessors(id, level='one') {

    ps_obj = {};

    if (level == 'one') {
        ps_obj.one = scenario.children_dict[id].predecessors;
    }
    if (level == 'two') {
        ps_obj.one = scenario.children_dict[id].predecessors;
        ps_obj.two = scenario.children_dict[ps_obj.one].predecessors;
    }
    if (level == 'three') {
        ps_obj.one = scenario.children_dict[id].predecessors;
        ps_obj.two = scenario.children_dict[ps_obj.one].predecessors;
        ps_obj.three = scenario.children_dict[ps_obj.two].predecessors;
    }

    return ps_obj[level];
}

function getLabel(element) {
    if (getTagValue(element, 'label') == undefined) {
        label = element;
    }
    else {
        label = getTagValue(element, 'label');
    }
    return label;
}

function getTagValue(element, tag) {
    return scenario.children_dict[element].tags[tag];
}

function getSequenceValue(element, sequence) {
    return scenario.children_dict[element].sequences[sequence];
}

function prepareTimeseries(id) {
    ts_obj = {};

    // If id is in the  hub_keys, the timeseries is the resdiual load
    var hub_keys = Object.keys(hubs);
    if (hub_keys.indexOf(id) > -1) {
        ts_obj.name = "Residuallast " + hubs[id];
        ts_obj.ts = getResidualLoad(id);
        ts_obj.color = '#2f1b56';
    }
    // otherwise we assume it to be a sequence of the element with the id
    else {
        ts_obj.name = id;
        coloring = getColors([id]);
        ts_obj.color = coloring[id].color;
        ts = getSequenceValue(id, lookup[id].profile);
        ts_obj.ts = ts.map(function(i) {
                return i * parseFloat(getTagValue(id, lookup[id].value));
        });
    }

    return ts_obj;
}

function getColors(element_names) {
    var coloring = {};

    element_names.forEach(function(name) {
        coloring[name] = {};
        if (scenario.children_dict[name].type == 'demand') {
            sector = getTagValue(tracePredecessors(name, level='one'), 'sector');
            coloring[name].color = global_colors[sector];
        }
        if (scenario.children_dict[name].type == 'volatile_generator') {
            coloring[name].color = global_colors[getTagValue(name, 'fuel_type')]
        }
        if (scenario.children_dict[name].type == 'combined_flexible_transformer') {
                coloring[name].opacity = 0.5;
        }

        if (scenario.children_dict[name].type == 'flexible_generator' ||
            scenario.children_dict[name].type == 'combined_flexible_generator') {

            // check for P2H Units
            if (getTagValue(tracePredecessors(name, level='one'), 'sector') == 'electricity') {
                coloring[name].color = global_colors['electricity'];
            }
            else {
                color_select = getTagValue(tracePredecessors(name, level='two'), 'commodity_type');
                coloring[name].color = global_colors[color_select];
            }
        }
    });
    return coloring;
}

function absoluteTimeseries(id, profile_type, multiplier) {
    seq = getSequenceValue(id, profile_type);
    ts = seq.map(function(i) {
        return i * parseFloat(getTagValue(id, multiplier));
    });
    return ts;
}

function addArrays(arrays) {
    var total_sum = [];
    for  (var t = 0; t < arrays[0].length; t++) {
        var sum_per_t = 0;
        for (var j=0; j < arrays.length; j++) {
            sum_per_t = sum_per_t + arrays[j][t];
        }
    total_sum.push(sum_per_t);
    }
    return total_sum;
}

// WORKS ONLY FOR VOLATILE GENERATORS AT THE MOMENT!
function getAreaUsage(element_name) {
    var area_select = getTagValue(element_name, 'fuel_type');

    if (area_select == undefined) {
        var area_usage = null;
    }
    else {
        var area_usage = getTagValue('area_factors', area_select) *
            parseFloat(getTagValue(element_name, 'installed_power'));
    }
    return area_usage;
}

function updateValue(slider_id, newValue) {
    document.getElementById(slider_id + "_slider").value = newValue;
    document.getElementById(slider_id + "_display").innerHTML = newValue;
    var l = lookup[slider_id];
    scenario.children_dict[slider_id].tags[l.value] = newValue;

    document.getElementById(slider_id + "_area").innerHTML = getAreaUsage(slider_id)
}


function renderEmissionBarPlot(plot_id) {

    getEmissionResults(scenario_db_id, multi_hub_name='kiel', function(data) {
        if (data == false) {
            $("#"+plot_id).html("");
            $("#"+plot_id).append("No results in db!");
        }
        else {
            makeEmissionBarPlot(div=plot_id, data=data,
                                layout={'title': 'CO2-Emissions in Kiel'});
        }
    });
}

function renderHubBarPlot(select_id, plot_id) {
    $("#"+select_id).html("");

    getHubs(scenario_db_id, function(data) {
        if (data == false) {
            $("#"+plot_id).html("");
            $("#"+plot_id).append("No hubs founds!");
        }
        else {

            $.each(data, function(key, value) {
                if ('name' in value) {
                   if (value.name in hubs) {
                       $("#"+select_id).append("<option value='"+value.name+"'>"+hubs[value.name]+"</option>");
                   }
                };
            });
        }
    });

    $("#"+select_id).on('change', function() {
        hub_name = $(this).val()
        nice_hub_name = $( "#"+select_id+" option:selected" ).text();
        result = getHubResults(scenario_db_id, hub_name, true, function(data) {

            if (data == false) {
               $("#"+plot_id).html("");
               $("#"+plot_id).append("No results in db!");
            }
            else {
                makeBarPlot(div=plot_id, data=data, layout={'title': nice_hub_name});
            }
        });
    });
}


function renderStackedResultPlot(select_id, plot_id) {
    $("#"+select_id).html("");

    getHubs(scenario_db_id, function(data) {
        if (data == false) {
            $("#"+plot_id).html("No hubs founds!");
        }
        else {

            $.each(data, function(key, value) {
                if ('name' in value) {
                   if (value.name in hubs) {
                       $("#"+select_id).append("<option value='"+value.name+"'>"+hubs[value.name]+"</option>");
                   }
                };
            });
        }
    });

    $("#"+select_id).on('change', function() {
        hub_name = $(this).val();
        nice_hub_name = $( "#"+select_id+" option:selected" ).text();

        getHubResults(scenario_db_id, hub_name, false, function(data) {
            if (data == false) {
               $("#"+plot_id).html("No results in db!");
            }
            else if (jQuery.isEmptyObject(data[hub_name].production)) {
               $("#"+plot_id).html(alertModal("No production for selected hub!"));
            }
            else {
                data.coloring = getColors(Object.keys(data[hub_name].production));
                makeStackedResultPlot(div=plot_id, data=data,
                                      layout={'title': nice_hub_name});
            }
        });
    });
}


// JQUERY TO START NEW MODEL RUN (Send json)
function runSimulation(scenario) {
        return $.ajax({
            url: 'simulate',
            type: 'put',
            data: JSON.stringify(scenario),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                alert("The simulation runs in the background."
                      +" See Jobs for an overview of running simmulation.");}
        });
    }



// GET RESULTS FUNCTION FOR AGGREGATE RESULTS
function getHubResults(scenario_db_id, hub_name, aggregated, callback) {
    return $.ajax({
        url: 'API/hub_results',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                hub_name: hub_name,
                aggregated: aggregated}
        })
    .done(callback)
    }


function getFlowResults(scenario_db_id, callback) {
    return $.ajax({
        url: 'API/flow_results',
        type: 'get',
        data : {scenario_id: scenario_db_id}
        })
    .done(callback)
    }

function getEmissionResults(scenario_db_id, multi_hub_name, callback) {
    return $.ajax({
        url: 'API/co2_results',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                multi_hub_name: multi_hub_name}
        })
    .done(callback)
    }

function getHubs(scenario_db_id, callback) {
 return $.ajax({
        url: 'API/elements',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                type: "hub",
                sequences: false,
                predecessors: false,
                successors: false,
                parents: false,
                geom: false,
                children: false}
        })
    .done(callback)
    }


function saveNewScenario(scenario) {
    do {
        var newScenarioName = prompt("New name", scenario['name']);
        if (newScenarioName == null) {
            return;
        }
    } while (newScenarioName == "");
    scenario['name'] = newScenarioName;
    var newScenarioDescription = prompt("New description", scenario['tags']['description']);
    if (newScenarioDescription == null) {
        return;
    }
    scenario['tags']['description'] = newScenarioDescription;
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Saved successfully! Opening new scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            if (! confirm("Scenario name is already taken. Try again.")) {
                return;
            }
            saveNewScenario(scenario);
        }
    });
}

function updateScenario(scenario) {
    // Delete existing scenario
    $.get('delete', {
        id: scenario_db_id
    });
    // Update scenario children from dict which is manipulated by slider
    scenario.children = Object.values(scenario.children_dict);
    // Use element API to write to DB
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Updated successfully! Opening updated scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            alert("Error. This should not have happened. Call somebody.");
        }
    });
}

function makeSlider(id, value, max) {
    return "<input id='"+id+"_slider' class='form-control' type='range' min='0' step='1' value='"
           +value+"' max='"+max+"' onchange="+'"'+"updateValue('"+id+"', this.value)"+'"'+"/>";
}

function makeSpan(id, value) {
    return "<span id="+id+">"+value+"</span>"
}

function makeAllSlider() {
    for (var element in lookup) {
        var l = lookup[element];
        $('#slider_form').append(
            '<div class="form-group row">'
                +'<label for="'+element+'" class="col-5 col-form-label">'+getLabel(element)+'</label>'
                +'<div class="col">'
                    +makeSlider(element, getTagValue(element, l.value), getTagValue(element, l.max))
                +'</div>'
			    +'<div class="col-1">'
                    +makeSpan(element+"_display", getTagValue(element, l.value))
                +'</div>'
			    +'<div class="col-1">'
                    // TODO: How to deal with area?
                   +makeSpan(element+"_area", 0)
                +"</div>"
            +"</div>");
    }
}

function renderResultFlowPlot(select_flow_id, select_type_id, plot_id) {
    getFlowResults(scenario_db_id, function(data) {
        $("#"+select_type_id).html("");
        ['chronological', 'duration', 'heatmap'].forEach( function (x) {
            $("#"+select_type_id).append("<option value='"+x+"'>"+x+"</option>");
        });
        if (data == false) {
            $("#"+plot_id).html("No results in db");
        }
        else {
            $("#"+plot_id).html("");
            var keys = Object.keys(data);
            $("#"+select_flow_id).html("");
            keys.forEach(function (key) {
                $("#"+select_flow_id).append("<option value='"+key+"'>"+key+"</option>");
            });
            var edge = $("#"+select_flow_id).val();
            var ts = {"name": edge, "ts": data[edge]};
            var type = $("#"+select_type_id).val();
            renderTimeseriesSubPlot(plot_id, type, ts);
            $("#"+select_flow_id).on('change', function() {
                var edge = $(this).val();
                var ts_obj = {"name": edge, "ts": data[edge]};
                var type = $("#"+select_type_id).val();
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
            // THIS IS NECESSARY FOR REORDERING ETC.
            $("#"+select_type_id).on('change', function() {
                var type = $(this).val();
                var edge = $("#"+select_flow_id).val();
                var ts = {"name": edge, "ts": data[edge]};
                renderTimeseriesSubPlot(plot_id, type, ts);
                });
        }
   });
}

function renderTimeseriesSubPlot(plot_id, type, ts_obj) {
    if (type == "chronological") {
        makeTimeseriesPlot(plot_id,
                           data={"name": ts_obj.name,
                                 "ts": ts_obj.ts,
                                 "color": ts_obj.color,
                                 "start_date": scenario.tags.year+"-01-01",
                                 "timestep": 3600},
                           layout={"title": ts_obj.name});
    } else if (type == "duration") {
        makeOrderedTimeseriesPlot(plot_id,
                                  data=ts_obj,
                                  layout={"title": "Duration curve of "+ts_obj.name});
    } else if (type == "heatmap") {
        makeHeatmapPlot(plot_id,
                        data=ts_obj,
                        layout={"title": "Heatmap of "+ts_obj.name});
    }
}

function renderInputTimeseries(select_ts_id, select_type_id, plot_id) {
        $("#"+select_type_id).html("");
        ['chronological', 'duration', 'heatmap'].forEach( function (x) {
            $("#"+select_type_id).append("<option value='"+x+"'>"+x+"</option>");
        });
        var keys = Object.keys(lookup);

        $("#"+select_ts_id).html("");
        keys.forEach(function (key) {
            if (timeseries_available.indexOf(key) > -1) {
                $("#"+select_ts_id).append("<option value='"+key+"'>"+getLabel(key)+"</option>");
            }
        });

        var hub_keys = Object.keys(hubs)
        hub_keys.forEach(function (key) {
            $("#"+select_ts_id).append("<option value='"+key+"'>"+"Residuallast "+hubs[key]+"</option>");
        });


        var edge = $("#"+select_ts_id).val();
        var ts_obj = prepareTimeseries(edge);
        var type = $("#"+select_type_id).val();
        renderTimeseriesSubPlot(plot_id, type, ts_obj);

        $("#"+select_ts_id).on('change', function() {
                var edge = $(this).val();
                var ts_obj = prepareTimeseries(edge);
                var type = $("#"+select_type_id).val();
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
        $("#"+select_type_id).on('change', function() {
                var type = $(this).val();
                var edge = $("#"+select_ts_id).val();
                var ts_obj = prepareTimeseries(edge);
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
}


function getResidualLoad(hub_name) {
    var arrays = []

    var predecessors = scenario.children_dict[hub_name].predecessors;
    var successors = scenario.children_dict[hub_name].successors;

    for (var i = 0; i < successors.length; i++) {
        var type = scenario.children_dict[successors[i]].type;
        if (type == 'demand') {
            var demand_ts = absoluteTimeseries(successors[i],
                                              'load_profile',
                                              'amount');
            arrays.push(demand_ts);
        }
    }
    for (var i = 0; i < predecessors.length; i++) {
        var type = scenario.children_dict[predecessors[i]].type;
        if (type == 'volatile_generator') {
            var renewable_ts = absoluteTimeseries(predecessors[i],
                                                  'generator_profile',
                                                  'installed_power');
            var negative_renewable_ts = renewable_ts.map(function(i) {
                                                            return i * -1;
                                                        });
            arrays.push(negative_renewable_ts);
        }
    }

    residual_load = addArrays(arrays);

    return residual_load;
}


var scenario_db_id = {{ scenario_db_id }};

var scenario = {{ scenario | tojson }};

var lookup = {{ slider_lookup | tojson }};

var timeseries_available = {{ timeseries_available | tojson }};

var hubs = {{ hubs | tojson }};

var plot_tabs = {{ plot_tabs | tojson }};

var global_colors = {{ global_colors | tojson }}

scenario.children_dict = {};

scenario.children.forEach(function(data) {
    scenario.children_dict[data.name] = data;
});

makeAllSlider();

plot_tabs.forEach(function(tab) {
    makeTab(tab.id, tab.label, tab.options, tab.content, tab.onclick, tab.active);
});

for (var element in lookup) {
    var l = lookup[element];
    updateValue(element, getTagValue(element, l.value));
}

//alertModal("this is the new alert modal. you can use it with alertModal(message) or alertModal(message, title). before you have to import script src=static/helper.js script", "NEW FEATURE");
alertModal("Here you can use the slider to edit your scenario. Make sure that you click 'Run Simulation' to compute results",
           "Edit your scenarios!");
</script>
{% endblock %}
