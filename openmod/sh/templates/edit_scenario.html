{% extends "base_layout.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdn.plot.ly/plotly-1.23.1.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket-leaflet.js"></script>
{% endblock %}

{% block header %}

<div style="float:left; width:50%;">
 Selected scenario: {{ scenario.get('name', 'NONE') }}
</div>
<div align="right", id="boxlink", style="float:left; width:25%;"
     onclick="updateScenario(scenario)">
 <a href="javascript:void(0)">Update scenario</a>
</div>
<div align="right", id="boxlink", style="float:right; width:25%;"
     onclick="saveNewScenario(scenario)">
 <a href="javascript:void(0)">Save New</a>
</div>

{% endblock %}

{% block body %}

<div style="float:left; width:35%;">

<h3>Select values</h3>
 <table style="width:50%">
  <caption>Kiel</caption>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td>{{_("Area Usage")}}</td>
  </tr>
  <tr>
    <td>{{_("Solar Roof")}}</td>
    <td>
        <input id="installed_power_solar_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('installed_power_solar', this.value)" /></td>
    <td>
        <span id="installed_power_solar_display">0</span>
    </td>
    <td>
        <span id="installed_power_solar_area">0</span>
    </td>
  </tr>
  <tr>
    <td>{{_("Solar Rural")}}</td>
    <td>
        <input id="solar_rural_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('solar_rural', this.value)" /></td>
    <td>
        <span id="solar_rural_display">0</span>
    </td>
    <td>
        <span id="solar_rural_area">0</span>
    </td>
  </tr>
  <tr>
    <td>{{_("Wind")}}</td>
    <td>
        <input id="installed_power_wind_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('installed_power_wind', this.value)" />
    </td>
    <td>
        <span id="installed_power_wind_display">0</span>
    </td>
    <td>
        <span id="installed_power_wind_area">0</span>
    </td>
   </tr>
   <tr>
    <td>{{_("Biomass CHP")}}</td>
    <td>
        <input id="biomass_chp_slider" type="range" min="0" max="50" value="0" step="5"
        onchange="updateValue('biomass_chp', this.value)" />
    </td>
    <td>
        <span id="biomass_chp_display">0</span>
    </td>
    <td>
        <span id="biomass_chp_area">0</span>
    </td>
  </tr>
</table>

<form action="{{ url_for('show_scenarios') }}"
      method=get>
<input type=submit value="Go to scenario overview">
</form>

<form action="{{ url_for('run_simulation') }}"
      method=get>
 <input type=submit value="Run simulation">
 <input type="hidden" name="id" value={{scenario_db_id}}>
</form>
</div>



<div style="float:right; width:65%;">
 <div class="tab">
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab1')" id="defaultOpen">Region Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab2')">Timeseries Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab3')">Heatmap Plot</a>
  <a href="javascript:void(0)" class="tablinks" onclick="openTab(event, 'Tab4');updateResults()">Bar Plot</a>
 </div>

 <div id="Tab1" class="tabcontent">
  <div id="region_plot"></div>
 </div>

 <div id="Tab2" class="tabcontent">
  <div id="timeseries_plot" style="height 300px;"></div>
  <button type="button" onclick="reorderTimeseries()">Reorder</button>
 </div>


 <div id="Tab3" class="tabcontent">
  <div id="heatmap_plot"></div>
 </div>

 <div id="Tab4" class="tabcontent">
  <div id="bar_plot"></div>
 </div>

</div>

{% endblock %}

{% block footer %}

<script type="text/javascript">
function updateValue(slider_id, newValue) {
    document.getElementById(slider_id + "_slider").value = newValue;
    document.getElementById(slider_id + "_display").innerHTML = newValue;
    document.getElementById(slider_id + "_area").innerHTML = newValue * 10;
    var l = lookup[slider_id];
    scenario.children_dict[l.child].tags[l.tag] = newValue;
    makeTimeseriesPlot();
    makeRegionPlot();
    makeHeatmapPlot();
}

function updateResults() {
    makeBarPlot(hub_name='kiel_electricity');
}

var timeseriesOrder = false;

// GET RESULTS FUNCTION FOR AGGREGATE RESULTS
function getResults(scenario_db_id, hub_name, callback) {
    return $.ajax({
        url: 'API/results/aggregated',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                hub_name: hub_name}
        })
    .done(callback)
    }


function makeBarPlot(hub_name) {

    result = getResults(scenario_db_id, hub_name, function(data) {

            if (data == false) {
                document.getElementById("Tab4").innerHTML = 'No results in db';
            }
            else {
                var x_vals = [];
                var y_vals = [];


                $.each(data, function(key, value) {
                    //console.log(key, value);
                    $.each(value['production'], function(comp_name, production) {
                        x_vals.push(comp_name);
                        y_vals.push(production);
                        //console.log(comp_name, production);
                    });
                });

                var layout =  {title: 'Summed electricity production',
                        axis: {
                            title: 'Technologies'
                        },
                        yaxis: {
                            title: 'Production in MWh'
                        }
                };
                var data = [{
                    x: x_vals,
                    y: y_vals,
                    type: 'bar'
                }
            ];

            Plotly.newPlot('bar_plot', data, layout);
          }

    });
}

function makeHeatmapPlot() {
    var dates = Array.apply(null, Array(8760)).map(function(_, i) {
        return new Date(i * 3600 * 1000);
    });
    var heat = scenario.children_dict.kiel_demand_heat.sequences.load_profile;
    heat = heat.map(function(i) {
        return i * scenario.children_dict.kiel_demand_heat.tags.amount
    });


    var data = []

    for (var i = 0; i < 24; i++) {
        data[i] = []
        for (var j = 0; j < 365; j++) {
            data[i].push(heat[j * 24 + i])
        }
    }

    var layout = {
        title: 'Heat demand MW in Kiel',
        axis: {
            title: 'Day of the year'
        },
        yaxis: {
            title: 'Hour of the day'
        }
    };

    var data = [{
        z: data,
        type: 'heatmap'
    }];

    Plotly.newPlot('heatmap_plot', data, layout);
}


function reorderTimeseries() {
    timeseriesOrder = !timeseriesOrder;
    makeTimeseriesPlot();
}

function makeTimeseriesPlot() {
    var dates = Array.apply(null, Array(8760)).map(function(_, i) {
        return new Date(i * 3600 * 1000);
    });
    var solar = scenario.children_dict.kiel_solar.sequences.generator_profile;
    solar = solar.map(function(i) {
        return i * scenario.children_dict.kiel_solar.tags.installed_power
    });
    var wind = scenario.children_dict.kiel_wind.sequences.generator_profile;
    wind = wind.map(function(i) {
        return i * scenario.children_dict.kiel_wind.tags.installed_power
    });

    var ts = []
    for (var i = 0; i < solar.length; i++) {
        ts.push(solar[i] + wind[i]);
    }

    var selectorOptions = {
        buttons: [{
                step: 'month',
                stepmode: 'backward',
                count: 1,
                label: '1m'
            },
            {
                step: 'all'
            }
        ]
    };
    var layout = {
        xaxis: {
            rangeselector: selectorOptions,
            rangeslider: {}
        },
        yaxis: {
            fixedrange: true
        }
    };

    if (timeseriesOrder) {
        ts = ts.sort(function(a, b) {
            return b - a
        });
        dates = Array.apply(null, Array(8760)).map(function(_, i) {
            return i + 1;
        });
        var data = [{
            type: 'scatter',
            mode: 'lines',
            line: {
                color: 'black'
            },
            fill: 'tozeroy',
            x: dates,
            y: ts
        }];
        layout.title = "Duration curve of electricity production in Kiel";
        Plotly.newPlot('timeseries_plot', data, layout);
    } else {
        var data = [{
            name: 'solar',
            type: 'scatter',
            mode: 'lines',
            line: {
                color: 'orange',
                width: 0
            },
            fill: 'tozeroy',
            fillcolor: 'orange',
            x: dates,
            y: solar
        }, {
            name: 'wind',
            type: 'scatter',
            mode: 'lines',
            line: {
                color: 'darkblue',
                width: 0
            },
            fill: 'tonexty',
            fillcolor: 'darkblue',
            x: dates,
            y: ts
        }];
        layout.title = "Stacked electricity production in Kiel";
        Plotly.newPlot('timeseries_plot', data, layout);
    }
}

function makeRegionPlot() {
    region_plot.outerHTML = '<div id="region_plot" style="width: 700px; height: 450px; position: relative;"></div>';
    var map = new L.Map('region_plot');
    // create the tile layer with correct attribution
    var osmUrl = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png';
    var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, {
        minZoom: 8,
        maxZoom: 12,
        attribution: osmAttrib
    });

    // start the map in South-East England
    map.setView(new L.LatLng(54.32133, 10.13489), 9);
    map.addLayer(osm);
    var polygons = ['kiel_electricity', 'ploe_electricity', 'nms_electricity', 'rdeck_electricity'];
    polygons.forEach(function(p) {
        var wicket = new Wkt.Wkt();
        var wkt_geom = scenario.children_dict[p].geom;
        wicket.read(wkt_geom);
        var polygon = wicket.toObject();
        map.addLayer(polygon);
    });
    var bars = ['installed_power_solar', 'installed_power_wind'];
    bars.forEach(function(b) {
        var l = lookup[b];
        barBottom = l.pos;
        barTop = [l.pos[0] + scenario.children_dict[l.child].tags[l.tag] / 100.0, l.pos[1]];
        var line = L.polyline([barBottom, barTop], {
            color: l.color,
            weight: 10,
            lineCap: 'butt'
        }).addTo(map);
    });
}

function saveNewScenario(scenario) {
    scenario['name'] = prompt("New name", scenario['name']);
    scenario['tags']['description'] = prompt("New description", scenario['tags']['description']);
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Saved successfully! Opening new scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            alert("Scenario name is already taken. Try again.");
            saveNewScenario(scenario);
        }
    });
}

function updateScenario(scenario) {
    // Delete existing scenario
    $.get('delete', {
        id: scenario_db_id
    });
    // Update scenario children from dict which is manipulated by slider
    scenario.children = Object.values(scenario.children_dict);
    // Use element API to write to DB
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            alert("Updated successfully! Opening updated scenario.");
            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
        },
        error: function() {
            alert("Error. This should not have happened. Call somebody.");
        }
    });
}


// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();

var scenario_db_id = {{ scenario_db_id }};

var scenario = {{ scenario | tojson }};

scenario.children_dict = {};
scenario.children.forEach(function(data) {
    scenario.children_dict[data.name] = data
});

lookup = {
    installed_power_solar: {
        child: "kiel_solar",
        tag: "installed_power",
        pos: [54.3, 10.1],
        color: 'orange'
    },
    installed_power_wind: {
        child: "kiel_wind",
        tag: "installed_power",
        pos: [54.3, 10.15],
        color: 'darkblue'
    }
};

updateValue("installed_power_solar", 12);
updateValue("installed_power_wind", 2);
</script>
{% endblock %}
