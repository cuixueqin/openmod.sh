{% extends "base_layout.html" %}

{% block head %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.plot.ly/plotly-1.23.1.min.js"></script>
<link rel="stylesheet" href="/static/jquery-ui.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket-leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>
{% endblock %}

{% block submenu %}


    <header>
        <div class="row align-items-center">
            <div class="col">
            <div class="title">{{ scenario.get('name', 'NONE') }}</div>
                Scenario
        </div>
            <div class="col text-right">
                <a class="btn noLink" href="#" id="sliderChangeInfo"></a>
                <a class="btn btn-primary" href="#" onclick="clickDiscard();" id="discardChanges" role="button"></a>
                <a class="btn btn-primary" href="javascript:void(0)" onclick="updateScenario(scenario)" role="button">Save changes</a>
                <a class="btn btn-primary" href="javascript:void(0)" onclick="callSaveScenarioPrompt(scenario)" role="button">Save as new scenario</a>
                <a class="btn btn-primary" href="javascript:void(0)" onclick="runSimulation(scenario)" role="button">Run Simulation</a>
        </div>
    </div>
    </header>



{% endblock %}


{% block content %}


<div class="card">
    <div class="row no-gutters">
        <div class="col-4">
            <div class="card-block right-border">
                <h5 class="card-title">Input Parameter</h5>
                <h6 class="card-subtitle"><br /></h6>
                <form id="slider_form"></form>
            </div>
        </div>
        <div class="col">
			 <div class="navbar-collapse">
               <ul class="nav nav-tabs" id="plot_tab"></ul>
            </div>
            <div class="card-block tab-content" id="plot_tab_content">
            </div>
        </div>
    </div>
</div>


<script src="/static/jquery-ui.min.js"></script>

<script src="static/plots.js"></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="static/helper.js"></script>

<script type="text/javascript">
function makeTab(id, label, options, content, additonalClass="", onclick="", active="") {
    var this_plot_tab = '<a class="nav-item nav-link ' + active + ' ' + additonalClass + '" onclick="'+onclick+'" data-toggle="tab" href="#'+id+'_tab">'+label+'</a>';
    $('#plot_tab').append(this_plot_tab);
    //$('#plot_tab_result').append(this_plot_tab);
    var this_plot_tab_content = '<div class="tab-pane '+active+'" id="'+id+'_tab" role="tabpanel">'
                                +'<div class="toolbar">'+options+'</br></div>'
                                +'<div id="'+id+'"></div>'
                                +content
                                +'</div>'
    $('#plot_tab_content').append(this_plot_tab_content);
}

function makeIndividualBiomethanSilder() {
    $('#slider_form').append("<div><b>Biomethan Anteil in Kiel</b></div>")
    var val = 100 - ((parseFloat(getTagValue('gas_commodity', 'emission_factor')) / 0.225)  * 100);
    $('#slider_form').append(
        '<div class="form-group row">'
            +'<label for="'+element+'" class="col-5 col-form-label">Anteil in %</label>'
            +'<div class="col">'
                +'<input id="biomethan_slider" class="form-control" type="range" min="0" step="1" value="'+val+'" max="100" onchange="updateBiomethanValue(this.value);"/>'
            +'</div>'
            +'<div class="col-1">'
                +'<span id="biomethan_value"></span>'
            +'</div>'
        +'</div>');
    updateBiomethanValue(val);
}

function updateBiomethanValue(value) {
    var new_value =  $("#biomethan_slider").val();
    $('#biomethan_value').html(new_value.toString());
}


function tracePredecessors(id, level='one') {
    ps_obj = {};

    if (level == 'one') {
        ps_obj.one = scenario.children_dict[id].predecessors;
    }
    if (level == 'two') {
        ps_obj.one = scenario.children_dict[id].predecessors;
        ps_obj.two = scenario.children_dict[ps_obj.one].predecessors;
    }
    if (level == 'three') {
        ps_obj.one = scenario.children_dict[id].predecessors;
        ps_obj.two = scenario.children_dict[ps_obj.one].predecessors;
        ps_obj.three = scenario.children_dict[ps_obj.two].predecessors;
    }

    return ps_obj[level];
}

function getLabel(element) {
    var keys = Object.keys(scenario.children_dict);
    if (keys.indexOf(element) == -1) {
        label = element;
    }
    else if (getTagValue(element, 'label') == undefined) {
        label = element;
    }
    else {
        label = getTagValue(element, 'label');
    }
    return label;
}

function getTagValue(element, tag) {
    //console.log(element, tag);
    return scenario.children_dict[element].tags[tag];
}

function roundTagValue(element, tag) {
    scenario.children_dict[element].tags[tag] = String(parseFloat(scenario.children_dict[element].tags[tag]).toFixed(1));
}

function getSequenceValue(element, sequence) {
    return scenario.children_dict[element].sequences[sequence];
}

function prepareTimeseries(id) {
    ts_obj = {};

    // If id is in the  hub_keys, the timeseries is the resdiual load
    var hub_keys = Object.keys(hubs);
    if (hub_keys.indexOf(id) > -1) {
        ts_obj.name = hubs[id];
        ts_obj.ts = getResidualLoad(id);
        ts_obj.color = '#2f1b56';
        ts_obj.type = "Residualload";
    }
    // otherwise we assume it to be a sequence of the element with the id
    else {
        ts_obj.name = getLabel(id);
        coloring = getColors([id]);
        ts_obj.color = coloring[id].color;
        if (scenario.children_dict[id].type == 'demand') {
            ts = getSequenceValue(id, 'load_profile');
            var amount = parseFloat(getTagValue(id, 'amount'));
            ts_obj.ts = ts.map(function(i) {
                return i * amount
            });
            ts.type = "Demand";
        }
        else {
            ts = getSequenceValue(id, 'generator_profile');
            var installed_power = parseFloat(getTagValue(id, 'installed_power'));
            ts_obj.ts = ts.map(function(i) {
                return i * installed_power
            });
            ts_obj.type = "Production";
        }
    }

    return ts_obj;
}

function getColors(element_names) {
    var coloring = {};

    element_names.forEach(function(name) {
        coloring[name] = {};
        if (scenario.children_dict[name].type == 'demand') {
            sector = getTagValue(tracePredecessors(name, level='one'), 'sector');
            coloring[name].color = global_colors[sector];
        }
        if (scenario.children_dict[name].type == 'volatile_generator') {
            coloring[name].color = global_colors[getTagValue(name, 'fuel_type')]
        }
        if (scenario.children_dict[name].type == 'combined_flexible_transformer') {
                coloring[name].opacity = 0.5;
        }
        if (scenario.children_dict[name].type == 'source') {
                coloring[name].color = global_colors['slack'];
        }
        if (scenario.children_dict[name].type == 'storage') {
                coloring[name].color = global_colors['storage'];;
        }

        if (scenario.children_dict[name].type == 'flexible_generator' ||
            scenario.children_dict[name].type == 'combined_flexible_generator' ||
            scenario.children_dict[name].type == 'extraction_turbine') {

            // check for P2H Units
            if (getTagValue(tracePredecessors(name, level='one'), 'sector') == 'electricity') {
                coloring[name].color = global_colors['electricity'];
            }
            else {
                color_select = getTagValue(tracePredecessors(name, level='two'), 'commodity_type');
                coloring[name].color = global_colors[color_select];
            }
        }
    });
    return coloring;
}

function absoluteTimeseries(id, profile_type, multiplier) {
    seq = getSequenceValue(id, profile_type);
    ts = seq.map(function(i) {
        return i * parseFloat(getTagValue(id, multiplier));
    });
    return ts;
}

function addArrays(arrays) {
    var total_sum = [];
    for  (var t = 0; t < arrays[0].length; t++) {
        var sum_per_t = 0;
        for (var j=0; j < arrays.length; j++) {
            sum_per_t = sum_per_t + arrays[j][t];
        }
    total_sum.push(sum_per_t);
    }
    return total_sum;
}

function getAreaUsage(element_name) {
    if (element_name == 'biomethan') {
        var biomethan_usage_specific = 0.5; //getTagValue('area_usage', 'biomethan');
        return biomethan_usage_specific;
    }
    else if (element_name == 'biomass') {
        var biomass_usage_specific = 0.5; //getTagValue('area_factors', 'biomass');
        return getSingleFlowResult(scenario_db_id, 'biomass_commodity_kiel', 'kiel_biomass',
                            function(data) {
                                    var sum = data.reduce(function(a,b) {
                                            return a+b;}, 0)
                                    var biomass_area_usage = sum * parseFloat(biomass_usage_specific)
                            });
        }
    else {
        var area_select = getTagValue(element_name, 'fuel_type');

        if (area_select == undefined) {
            var area_usage = null;
        }
        else {
            var area_usage = getTagValue('area_factors', area_select) *
                parseFloat(getTagValue(element_name, 'installed_power'));
        }
        return area_usage;
      }
}

function updateValue(slider_id, newValue) {
    document.getElementById(slider_id + "_slider").value = newValue;
    document.getElementById(slider_id + "_display").innerHTML = newValue;
    var l = lookup[slider_id];
    scenario.children_dict[slider_id].tags[l.value] = newValue;
}


function renderEmissionBarPlot(plot_id) {

    getEmissionResults(scenario_db_id, multi_hub_name='kiel', function(data) {
        if (data == false) {
            $("#"+plot_id).html("");
            $("#"+plot_id).append("No results in db!");
        }
        else {
            makeEmissionBarPlot(div=plot_id, data=data,
                                layout={'title': 'CO2-Emissions in Kiel'});
        }
    });
}

function appendToDiv(div_id, text) {
    $('#'+div_id).append(text+'<br><br>');
}

function createTable(columns, table_id="summary_table") {
    var columns_html = []
    for (var i=0; i<columns.length; i++) {
        columns_html.push("<th>"+columns[i]+"</th>");
    }
    var table =
        '<table class="table table-hover" id="'+table_id+'">'
        +'<thead><tr>'
        +columns_html.reduce(function(a,b) {return String(a)+String(b);}, "")
        +'</tr></thead>'
        +'<tbody></tbody>'
        +'</table>';
    return table;
}

function addTableRow(columns, table_id) {
    var row_html = [];
    for (var i=0; i<columns.length; i++) {
        row_html.push('<td>'+columns[i]+'</td>');
    }
    var row =
        '<tr>'
        +row_html.reduce(function(a,b) {return String(a)+String(b);}, "")
        +'</tr>';
    $('#'+table_id+' tbody').append(row);
}

function prepareRow(keys, dct, factor, firstc, secondc) {
    var row = [];
    for (var i=0; i<keys.length; i++) {
        var key = keys[i];
        var number = dct[key]/factor;
        row.push(number.toFixed(1));
    }
    row.splice(0,0, firstc, secondc);
    return row;
}


function renderResultSummary(div_id) {
    $('#'+div_id).html("");

    // AREA USAGE (REMOVE AFTER KIEL WORKSHOP!!!!)
    var area_helper = {'kiel_solar':'KI Solar',
                       'kiel_wind':'KI Wind',
                       'biogas':'Biomethan Import' ,
                       'biomass':'Biomasse Import'};
    var area_columns = ["kiel_solar", "biomethan", "biomass"];
    var all_area_columns = JSON.parse(JSON.stringify(area_columns));
    all_area_columns.splice(0, 0, "Area", "");
    var area_dct = {};
    var relative_area_dct = {};

    appendToDiv(div_id,
        createTable(
            all_area_columns.map(
                function (x) {
                    if (area_helper[x] != undefined) {
                        return area_helper[x];
                    } else {
                        return x;
                      }}),
                    "summary_area"));

    for (var i=0; i < area_columns.length; i++) {
        area_dct[area_columns[i]] = getAreaUsage(area_columns[i])
        relative_area_dct[area_columns[i]] = getAreaUsage(area_columns[i]) / 11865 * 100
    }
    var area_row = prepareRow(area_columns, area_dct, 1, "Area", "in ha");
    addTableRow(area_row, "summary_area");
    var relative_area_row = prepareRow(area_columns, relative_area_dct, 1, "Area", "in %");
    addTableRow(relative_area_row, "summary_area");

    // EMISSIONS RESULTS
    getEmissionResults(scenario_db_id, multi_hub_name='kiel', function(data) {
        var helper = {'electricity':'Strom', 'heat':'Wärme' ,
                      'import':'Import', 'export': 'Export'};
        var columns = Object.keys(helper);
        var all_columns = JSON.parse(JSON.stringify(columns));
        all_columns.splice(0, 0, "Emissionen", "");
        appendToDiv(
            div_id,
            createTable(
                all_columns.map(
                    function (x) {
                        if (helper[x] != undefined) {
                            return helper[x];
                        } else {
                            return x;
                        }}),
                "summary_emissions"));
        var row = prepareRow(columns, data, 1000, "Emissionen", "in 1000 t");
        addTableRow(row, "summary_emissions");
    });

    getHubResults(scenario_db_id, 'kiel_electricity', true, function(data) {
        var production_dct = data.kiel_electricity.production;
        var total_production = Object.values(production_dct).reduce(function(a,b) {
            return a+b;}, 0);
        var relative_production_dct = {}
        var installed_power_dct = {};
        var fullload_hours_dct = {};
        var area_usage_dct = {};
        Object.keys(production_dct).forEach(function(x) {
            var installed_power = scenario.children_dict[x].tags.installed_power;
            var production = production_dct[x];
            relative_production_dct[x] = production/total_production;
            installed_power_dct[x] = installed_power;
            fullload_hours_dct[x] = production_dct[x]/installed_power;
            area_usage_dct[x] = getAreaUsage(x);
            if ((!installed_power) || installed_power=='null' || installed_power==0) {
                if (production !== 0) {
                    console.log("installed_power of "+x+" is null or 0 but production is "+production);
                }
                installed_power_dct[x] = 0;
                fullload_hours_dct[x] = 0;
            }
        });
        var columns = Object.keys(production_dct);
        var all_columns = JSON.parse(JSON.stringify(columns));

        all_columns.splice(0,0,"Electricity Production", "");
        appendToDiv(div_id, createTable(all_columns.map(function(name){return(getLabel(name));}), "summary_table_kiel_electricity_production"));
        var row = prepareRow(columns, installed_power_dct, 1,
                             "Installed power", "in MW");
        addTableRow(row, "summary_table_kiel_electricity_production");
        var row = prepareRow(columns, production_dct, 1000,
                             "Electricity production", "in GWh");
        addTableRow(row, "summary_table_kiel_electricity_production");
        var row = prepareRow(columns, fullload_hours_dct, 1,
                             "Fullload hours", "in h");
        addTableRow(row, "summary_table_kiel_electricity_production");
        var row = prepareRow(columns, relative_production_dct, 1/100,
                             "Share of production in Kiel", "in %");

        addTableRow(row, "summary_table_kiel_electricity_production");
    });

    getHubResults(scenario_db_id, 'kiel_heat', true, function(data) {
        var production_dct = data.kiel_heat.production;
        var total_production = Object.values(production_dct).reduce(function(a,b) {
            return a+b;}, 0);
        var relative_production_dct = {}
        var installed_power_dct = {};
        var fullload_hours_dct = {};
        Object.keys(production_dct).forEach(function(x) {
            var installed_power = 0;
            if (scenario.children_dict[x].type == 'flexible_generator') {
                installed_power = parseFloat(scenario.children_dict[x].tags.installed_power);
            }
            if (scenario.children_dict[x].type == 'combined_flexible_generator' ||
                scenario.children_dict[x].type == 'extraction_turbine') {
                installed_power = parseFloat(scenario.children_dict[x].tags.installed_power) /
                                    parseFloat(scenario.children_dict[x].tags.electrical_efficiency) *
                                    parseFloat(scenario.children_dict[x].tags.thermal_efficiency);
            }
            var production = production_dct[x];
            relative_production_dct[x] = production/total_production;
            installed_power_dct[x] = installed_power;
            fullload_hours_dct[x] = production_dct[x]/installed_power;

            if ((!installed_power) || installed_power=='null' || installed_power==0) {
                if (production !== 0) {
                    console.log("installed_power of "+x+" is null or 0 but production is "+production);
                }
                installed_power_dct[x] = 0;
                fullload_hours_dct[x] = 0;
            }
        });
         var columns = Object.keys(production_dct);
        var all_columns = JSON.parse(JSON.stringify(columns));

        all_columns.splice(0,0,"Heat Production", "");
        appendToDiv(div_id, createTable(all_columns.map(function(name){return(getLabel(name));}),
                    "summary_table_kiel_heat_production"));
        var row = prepareRow(columns, installed_power_dct, 1,
                             "Installed power", "in MW");
        addTableRow(row, "summary_table_kiel_heat_production");
        var row = prepareRow(columns, production_dct, 1000,
                             "Heat production", "in GWh");
        addTableRow(row, "summary_table_kiel_heat_production");
        var row = prepareRow(columns, fullload_hours_dct, 1,
                             "Fullload hours", "in h");
        addTableRow(row, "summary_table_kiel_heat_production");
        var row = prepareRow(columns, relative_production_dct, 1/100,
                             "Share of production in Kiel", "in %");
        addTableRow(row, "summary_table_kiel_heat_production");
    });


}

function renderHubBarPlot(select_id, plot_id) {
    $("#"+select_id).html("");

    getHubs(scenario_db_id, function(data) {
        if (data == false) {
            $("#"+plot_id).html("");
            $("#"+plot_id).append("No hubs founds!");
        }
        else {
            $.each(data, function(key, value) {
                if ('name' in value) {
                   if (value.name in hubs) {
                       $("#"+select_id).append("<option value='"+value.name+"'>"+hubs[value.name]+"</option>");
                   }
                };
            });
        // Render first time when landing on tab and options have been 'build'
        hub_label = $( "#"+select_id+" option:selected" ).text();
        hub_name = $( "#"+select_id+" option:selected" ).val();
        HubSubBarPlot(scenario_db_id, hub_label, hub_name, plot_id);
        }
    });

    // Re-Render when other hub is selected
    $("#"+select_id).on('change', function() {
        var hub_name = $(this).val()
        var hub_label = $( "#"+select_id+" option:selected" ).text();
        HubSubBarPlot(scenario_db_id, hub_label, hub_name, plot_id)
    });
}

function HubSubBarPlot(scenario_db_id, hub_label, hub_name, plot_id) {
    result = getHubResults(scenario_db_id, hub_name, true, function(data) {
        if (data == false) {
            $("#" + plot_id).html("");
            $("#" + plot_id).append("No results in db!");
        } else {
            makeBarPlot(div = plot_id, data = data,
                layout = {
                    'title': "Yearly Production, Consumption and Im-/Export in " + hub_label
                });
        }
    });

}

function renderStackedResultPlot(select_id, plot_id) {
    $("#"+select_id).html("");

    getHubs(scenario_db_id, function(data) {
        if (data == false) {
            $("#"+plot_id).html("No hubs founds!");
        }
        else {
            $.each(data, function(key, value) {
                if ('name' in value) {
                   if (value.name in hubs && value.name != 'nms_electricity') {
                       $("#"+select_id).append("<option value='"+value.name+"'>"+hubs[value.name]+"</option>");
                   }
                };
            });
        // Render first time when lading on page
        hub_label = $( "#"+select_id+" option:selected" ).text();
        hub_name = $( "#"+select_id+" option:selected" ).val();
        StackedResultSubPlot(scenario_db_id, hub_label, hub_name, plot_id);
        }
    });

    // Re-Render when other hub is selected
    $("#"+select_id).on('change', function() {
        hub_name = $(this).val();
        hub_label = $( "#"+select_id+" option:selected" ).text();
        StackedResultSubPlot(scenario_db_id, hub_label, hub_name, plot_id);

    });
}

function StackedResultSubPlot(scenario_db_id, hub_label, hub_name, plot_id) {
    getHubResults(scenario_db_id, hub_name, false, function(data) {
        if (data == false) {
           $("#"+plot_id).html("No results in db!");
        }
        else if (jQuery.isEmptyObject(data[hub_name].production)) {
           $("#"+plot_id).html(alertModal("No production for selected hub!"));
        }
        else {
            keys = Object.keys(data[hub_name].production).concat(Object.keys(data[hub_name].demand));
            data.coloring = getColors(keys);
            data.start_date = scenario.tags.year+"-01-01";
            data.timestep = 3600;
            makeStackedResultPlot(div=plot_id, data=data,
                                  layout={'title': "Hourly Production and Demand in "+hub_label,
                                          'yaxis_title': "Production and Demand in MW"});
        }
    });

}



function renderStackedInputPlot(select_id, plot_id) {
    $("#"+select_id).html("");

    getHubs(scenario_db_id, function(data) {
        if (data == false) {
            $("#"+plot_id).html("No hubs founds!");
        }
        else {
            $.each(data, function(key, value) {
                if ( 'name' in value ) {
                   var skip_hubs = ['nms_electricity', 'kiel_heat']
                   if (skip_hubs.indexOf(value.name) < 0) {
                       if (value.name in hubs) {
                           $("#"+select_id).append("<option value='"+value.name+"'>"+hubs[value.name]+"</option>");
                       }
                   }
                };
            });
        hub_name = $( "#"+select_id+" option:selected" ).val();
        renderStackedInputSubPlot(hub_name, select_id, plot_id);
        }
    });

    $("#"+select_id).on('change', function() {
        $("#"+plot_id).html("");
        var hub_name = $(this).val();
        renderStackedInputSubPlot(hub_name, select_id, plot_id);

        });
}


function renderStackedInputSubPlot(hub_name, select_id, plot_id) {

    var data = {};
    data[hub_name] = {'production':{}, 'demand':{}};

    var elements = [];
    var predecessors = scenario.children_dict[hub_name].predecessors;
    var slider_input_names = Object.keys(lookup);

    for (var i in predecessors) {
        if (scenario.children_dict[predecessors[i]].type == 'volatile_generator') {
            elements.push(predecessors[i]);
        }
    }

    for (var i = 0; i < elements.length; i++) {
        var ts_obj = prepareTimeseries(elements[i]);
        data[hub_name]['production'][elements[i]] = ts_obj.ts;
    }
    // GET THE DEMAND
    var successors = scenario.children_dict[hub_name].successors;
    for (var i in successors) {
        if (scenario.children_dict[successors[i]].type == 'demand') {
            ts_obj = prepareTimeseries(successors[i]);
            data[hub_name]['demand'][successors[i]] = ts_obj.ts;
            elements.push(successors[i]);
        }
    }
    if ($.isEmptyObject(data[hub_name]['production']) ||
        $.isEmptyObject(data[hub_name]['demand'])) {
        $("#"+plot_id).html("No data to render!");
    }
    else {
        nice_hub_name = $("#"+select_id+" option:selected" ).text();
        data.coloring = getColors(elements);
        data.start_date = scenario.tags.year+"-01-01";
        data.timestep = 3600;
        makeStackedInputPlot(plot_id, data,
                             layout={'title':"Hourly Renewable Production and Demand in "+nice_hub_name,
                                     'yaxis_title': "Production and Demand in MW"});
        }

}

// JQUERY TO START NEW MODEL RUN (Send json)
function runSimulation(scenario) {
    if (!slider_changed) {
        return $.ajax({
            url: 'simulate',
            type: 'put',
            data: JSON.stringify(scenario),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                setResultExists();
                alertModal("The simulation runs in the background."
                           +" See Jobs for an overview of running simmulation.");}
        });
    } else {
        alertModal("There are unsaved changes. You have to save them before you can run a simulation.", "Unsaved changes");
    }
}



// GET RESULTS FUNCTION FOR AGGREGATE RESULTS
function getHubResults(scenario_db_id, hub_name, aggregated, callback) {
    return $.ajax({
        url: 'API/hub_results',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                hub_name: hub_name,
                aggregated: aggregated}
        })
    .done(callback)
    }

function getSingleFlowResult(scenario_db_id, predecessor, successor, callback) {
    return $.ajax({
        url: 'API/single_flow_result',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                predecessor: predecessor,
                successor: successor}
        })
    .done(callback)
    }

function getFlowResults(scenario_db_id, subset, callback) {
    return $.ajax({
        url: 'API/flow_results',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                subset: subset}
        })
    .done(callback)
    }

function getEmissionResults(scenario_db_id, multi_hub_name, callback) {
    return $.ajax({
        url: 'API/co2_results',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                multi_hub_name: multi_hub_name}
        })
    .done(callback)
    }

function getHubs(scenario_db_id, callback) {
 return $.ajax({
        url: 'API/elements',
        type: 'get',
        data : {scenario_id: scenario_db_id,
                type: "hub",
                sequences: false,
                predecessors: false,
                successors: false,
                parents: false,
                geom: false,
                children: false}
        })
    .done(callback)
    }

function callSaveScenarioPrompt(scenario) {
    // Get name
    promptModal("New Name", "", "Senario Name", function (input) {
        if(input == null) {
            return;
        }
        if(input.length == 0) {
            // Maybe just Inform
            alertModal('alert', 'Input needs to be more than 0 characters.');
            return;
        }
        scenario.name = input;
        // Get Des
        promptModal("", scenario['tags']['description'], "New description", function (input) {
            if(input != null){
                scenario['tags']['description'] = input;
                saveNewScenario(scenario);
            }
            else {
                //abgebrochen
            }
        });
    });
}

function saveNewScenario(scenario) {
    // INDIVIDUAL FOR BIOMETHAN SLIDER DIRTY HACK
    new_value =  $("#biomethan_slider").val();
    emission_factor_new = 0.225 * (1 - (new_value / 100));
    scenario.children_dict["gas_commodity"].tags["emission_factor"] = emission_factor_new;
    // END OF DIRTY HACK
    $.ajax({
        url: 'API/element',
        type: 'post',
        data: JSON.stringify(scenario),
        headers: {
            'Content-Type': 'application/json'
        },
        dataType: 'json',
        success: function(data) {
            resetSliderChange();
            alertModal("Saved successfully! Opening new scenario.", "Info", function() {
                window.location.replace('edit_scenario?id=' + data.scenario_db_id);
            });
        },
        error: function() {
            confirmModal("Scenario name is already taken. Try again.", "Alert", function(input) {
                if(input != null) {
                    callSaveScenarioPrompt(scenario);
                }
                else {
                    return;
                }
            });
        }
    });
}


function updateScenario(scenario) {
    // Delete existing scenario
    confirmModal("Override existing scenario with new values?", "Alert",
        function(input) {
            if(input == true) {
                // If confirmed, delete scenario
                $.get('delete', {
                    id: scenario_db_id
                });
                // Update scenario children from dict which is manipulated by slider
                // INDIVIDUAL FOR BIOMETHAN SLIDER DIRTY HACK
                new_value =  $("#biomethan_slider").val();
                emission_factor_new = 0.225 * (1 - (new_value / 100));
                scenario.children_dict["gas_commodity"].tags["emission_factor"] = emission_factor_new;
                // END OF DIRTY HACK
                scenario.children = Object.values(scenario.children_dict);
                // Use element API to write to DB
                $.ajax({
                    url: 'API/element',
                    type: 'post',
                    data: JSON.stringify(scenario),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    dataType: 'json',
                    success: function(data) {
                        resetSliderChange();
                        alertModal("Opening updated scenario.", "Updated successfully!", function () {
                            window.location.replace('edit_scenario?id=' + data.scenario_db_id);
                        });
                    },
                    error: function() {
                        alert("Error. This should not have happened. Call somebody.");
                    }
                });


                } else {
        	           return;
    	             }
             });


}

function makeSlider(id, value, max) {
    return "<input id='"+id+"_slider' class='form-control' type='range' min='0' step='0.1' value='"
           +value+"' max='"+max+"' onchange="+'"'+"updateValue('"+id+"', this.value)"+'"'+"/>";
}

function makeSpan(id, value) {
    return "<span id="+id+">"+value+"</span>"
}

var max_bar=0;

function makeAllAutomaticSlider() {
    $.each(region_bar_plot, function(key, value) {
       if (region_bar_plot[key]["values"].length > 0) {
           $('#slider_form').append("<div><b>"+region_bar_plot[key]['label']+"</b></div>");
       }
        $.each(value.values, function(index)  {
            var element  = value.values[index];
            var l = lookup[element];
            if (getTagValue(element, l.value) != "null") {
                roundTagValue(element, l.value);
                roundTagValue(element, l.max);
                var slider_max = 2*parseFloat(getTagValue(element, l.max));
                if (slider_max > max_bar) {
                    max_bar = slider_max;
                }
                $('#slider_form').append(
                    '<div class="form-group row">'
                        +'<label for="'+element+'" class="col-4 col-form-label">'+getLabel(element)+'</label>'
                        +'<div class="col">'
                            +makeSlider(element, getTagValue(element, l.value), slider_max)
                        +'</div>'
        			    +'<div class="col-2">'
                            +makeSpan(element+"_display", getTagValue(element, l.value))
                        +'</div>'
                    +"</div>");
            }
        });
    });
}


function renderResultFlowPlot(select_flow_id, select_type_id, plot_id) {
    getFlowResults(scenario_db_id, subset='true', function(data) {
        $("#"+select_type_id).html("");
        ['chronological', 'duration', 'heatmap'].forEach( function (x) {
            $("#"+select_type_id).append("<option value='"+x+"'>"+x[0].toUpperCase() + x.slice(1,x.length)+"</option>");
        });
        if (data == false) {
            $("#"+plot_id).html("No results in db");
        }
        else {
            $("#"+plot_id).html("");
            var keys = Object.keys(data);
            $("#"+select_flow_id).html("");
            keys.forEach(function (key) {
                $("#"+select_flow_id).append("<option value='"+key+"'>"+key+"</option>");
            });
            var edge = $("#"+select_flow_id).val();
            var ts_obj = {"name": edge, "ts": data[edge], "type": "Flow"};
            var type = $("#"+select_type_id).val();
            renderTimeseriesSubPlot(plot_id, type, ts_obj);
            $("#"+select_flow_id).on('change', function() {
                var edge = $(this).val();
                var ts_obj = {"name": edge, "ts": data[edge], "type": "Flow"};
                var type = $("#"+select_type_id).val();
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
            // THIS IS NECESSARY FOR REORDERING ETC.
            $("#"+select_type_id).on('change', function() {
                var type = $(this).val();
                var edge = $("#"+select_flow_id).val();
                var ts_obj = {"name": edge, "ts": data[edge], "type": "Flow"};
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
        }
   });
}

function renderTimeseriesSubPlot(plot_id, type, ts_obj) {
    if (type == "chronological") {
        makeTimeseriesPlot(plot_id,
                           data={"name": ts_obj.name,
                                 "ts": ts_obj.ts,
                                 "color": ts_obj.color,
                                 "start_date": scenario.tags.year+"-01-01",
                                 "timestep": 3600},
                           layout={"title": "Hourly " + ts_obj.type + " " + getLabel(ts_obj.name),
                                   "yaxis_title": ts_obj.type + " in MW"});
    } else if (type == "duration") {
        makeOrderedTimeseriesPlot(plot_id,
                                  data=ts_obj,
                                  layout={"title": "Duration curve of "+getLabel(ts_obj.name),
                                          "yaxis_title": ts_obj.type + " in MW"});
    } else if (type == "heatmap") {
        makeHeatmapPlot(plot_id,
                        data=ts_obj,
                        layout={"title": "Heatmap of "+ getLabel(ts_obj.name) + " in MW",
                                "yaxis_title": ts_obj.type + " in MW"});
    }
}

function renderInputTimeseries(select_ts_id, select_type_id, plot_id) {
        $("#"+select_type_id).html("");
        ['chronological', 'duration', 'heatmap'].forEach( function (x) {
            $("#"+select_type_id).append("<option value='"+x+"'>"+x[0].toUpperCase() + x.slice(1,x.lenght)+"</option>");
        });
        var keys = Object.keys(lookup);

        $("#"+select_ts_id).html("");
        keys.forEach(function (key) {
            if (timeseries_available.indexOf(key) > -1) {
                $("#"+select_ts_id).append("<option value='"+key+"'>"+getLabel(key)+"</option>");
            }
        });

        var hub_keys = Object.keys(hubs)
        hub_keys.forEach(function (key) {
            $("#"+select_ts_id).append("<option value='"+key+"'>"+hubs[key]+" Residuallast"+"</option>");
        });


        var edge = $("#"+select_ts_id).val();
        var ts_obj = prepareTimeseries(edge);
        var type = $("#"+select_type_id).val();
        renderTimeseriesSubPlot(plot_id, type, ts_obj);


        $("#"+select_ts_id).on('change', function() {
                var edge = $(this).val();
                var ts_obj = prepareTimeseries(edge);
                var type = $("#"+select_type_id).val();
                renderTimeseriesSubPlot(plot_id, type, ts_obj);
                });
        $("#"+select_type_id).on('change', function() {
                var type = $(this).val();
                var edge = $("#"+select_ts_id).val();
                var ts_obj = prepareTimeseries(edge);
                renderTimeseriesSubPlot(plot_id, type, ts_obj);

        });
}


function renderInputOverview(plot_id) {
    var input_overview_map = makeRegionPlot(plot_id);
    Object.values(region_bar_plot).forEach(function(region) {
        var bound = addGridToRegionPlot(input_overview_map, region.pos, 0.15, 0.3);
        var number_of_values = region.values.length;
        var left_lower = bound[0];
        var width = bound[1][1]-bound[0][1];
        var dwidth = width/(number_of_values+1);
        for(var i=0; i<number_of_values; i++) {
            var bar = region.values[i];
            var l = lookup[bar];
            var value = scenario.children_dict[bar].tags[l.value];
            var size_factor = max_bar*4;
            //console.log(bar, value);
            addBarToRegionPlot(input_overview_map, left_lower[0], left_lower[1]+dwidth*(i+1), value/size_factor, getLabel(bar)+": "+value+" MW", getColors([bar])[bar].color);
        }
    });
}

function renderResultOverview(plot_id) {
    getFlowResults(scenario_db_id, subset='false', function(data) {

        var flow_results = data;

        $('#'+plot_id).html("");
        var result_overview_map = makeRegionPlot(plot_id);
        var positions = {};
        Object.keys(region_bar_plot).forEach(function(key) {
            positions[key] = region_bar_plot[key].pos;
        });
        var number_of_positions = Object.values(positions).length;
        var arrows = {};
        var max = 0;
        Object.keys(positions).forEach(function(k) {
            arrows[k] = {}
            Object.keys(positions).forEach(function(l) {
                if (k !== l) {
                    var value = flow_results[k+' -> '+l].reduce(function(a, b) {return a+b;});
                    arrows[k][l] = value;
                    if (value > max) {
                        max = value;
                    }
                }
            });
        });
        var pixel_add = 12;
        Object.keys(region_bar_plot).forEach(function(region_id) {
            var region = region_bar_plot[region_id];
            var bound = addGridToRegionPlot(result_overview_map, region.pos, 0.15, 0.3);
            var arrow_length = 0.01;
            var arrow_distance = 0.05;
            var import_arrow = JSON.parse(JSON.stringify(region.pos));
            import_arrow = [[import_arrow[0]+arrow_length, import_arrow[1]-arrow_distance],
                            [import_arrow[0], import_arrow[1]-arrow_distance]];
            var export_arrow = JSON.parse(JSON.stringify(region.pos));
            export_arrow = [[export_arrow[0], export_arrow[1]+arrow_distance],
                            [export_arrow[0]+arrow_length, export_arrow[1]+arrow_distance]];
            var import_value = flow_results['BRD_electricity -> '+region_id].reduce(function(a, b) {return a+b;});
            var export_value = flow_results[region_id+' -> BRD_electricity'].reduce(function(a, b) {return a+b;});
            if (import_value > max) {
                max = import_value;
            }
            if (export_value > max) {
                max = export_value;
            }
            addArrowToRegionPlot(result_overview_map, import_arrow[0], import_arrow[1],
                     import_value,
                     'BRD'+' -> '+getLabel(region_id)+': '+Math.round(import_value/1000)+' GWh',
                     import_value/max*pixel_add,
                     shorten=false);
            addArrowToRegionPlot(result_overview_map, export_arrow[0], export_arrow[1],
                     export_value,
                     getLabel(region_id)+' -> '+'BRD'+': '+Math.round(export_value/1000)+' GWh',
                     export_value/max*pixel_add,
                     shorten=false);
        });
        Object.keys(arrows).forEach(function(k) {
            Object.keys(arrows[k]).forEach(function(l) {
                var value = arrows[k][l];
                addArrowToRegionPlot(result_overview_map, positions[k], positions[l],
                                     value,
                                     getLabel(k)+' -> '+getLabel(l)+': '+Math.round(value/1000)+' GWh',
                                     value/max*pixel_add);
            });
        });
    });
}

function getResidualLoad(hub_name) {
    var arrays = []

    var predecessors = scenario.children_dict[hub_name].predecessors;
    var successors = scenario.children_dict[hub_name].successors;

    for (var i = 0; i < successors.length; i++) {
        var type = scenario.children_dict[successors[i]].type;
        if (type == 'demand') {
            var demand_ts = absoluteTimeseries(successors[i],
                                              'load_profile',
                                              'amount');
            arrays.push(demand_ts);
        }
    }
    for (var i = 0; i < predecessors.length; i++) {
        var type = scenario.children_dict[predecessors[i]].type;
        if (type == 'volatile_generator') {
            var renewable_ts = absoluteTimeseries(predecessors[i],
                                                  'generator_profile',
                                                  'installed_power');
            var negative_renewable_ts = renewable_ts.map(function(i) {
                                                            return i * -1;
                                                        });
            arrays.push(negative_renewable_ts);
        }
    }

    residual_load = addArrays(arrays);

    return residual_load;
}

function clickDiscard() {
    confirmModal("Do you really want to loose your changes?",  "Alert",
            function(input) {
                if(input == true) {
                    location.reload();
                } else {
        	           return;
    	             }
             });
}


function setSliderChangeInfo() {
    if (slider_changed) {
        $('#sliderChangeInfo').show();
        $('#sliderChangeInfo').html("WITH CHANGES");
        $('#discardChanges').show();
        $('#discardChanges').html("Discard Changes");
    } else {
         $('#sliderChangeInfo').hide();
         $('#discardChanges').hide();
    }
}

function resetSliderChange() {
    slider_changed = false;
    setSliderChangeInfo();
}

function checkIfResultExists(scenario_db_id, callback) {
    return $.ajax({
        url: 'API/flow_results',
        type: 'get',
        data : {scenario_id: scenario_db_id}
        })
    .done(callback);
}


function setResultExists(once=false) {
    checkIfResultExists(scenario_db_id, function(data) {
        console.log("checking if results exist");
        if (data == false) {
            result_exists = false;
            if (!once) {
                window.setTimeout(setResultExists, 10000);
            }
        } else {
            result_exists = true;

            if (!once) {
                if (!slider_changed) {
                    alertModal("The simulation for this scenario is finished.", "Results are available");
                    updateDisabledPlotTabs();
                } else {
                	result_exists = false;
                    alertModal("The simulation for the last scenario is finished.<br><br>"
                               +"But since starting the simulation you have changed some slider values.<br><br>"
                               +"If you want to keep your changes, save them as a new scenario.<br><br>"
                               +"If you want to discard the changes and see the results, just refresh this page.",
                               "Results are available, but...");
               }
            } else {
            	if(slider_changed)
            		result_exists = false;

                updateDisabledPlotTabs();
            }
        }
    });
}

function updateDisabledPlotTabs() {
    if (result_exists) {
        $("#plot_tab .collapse").show();
    } else {
        $("#plot_tab .collapse").hide();
        var input_tabs = ["#input_overview", "#input_timeseries_tab", "#input_stacked_tab"];
        if ( input_tabs.indexOf($('.nav a.active')[0]['hash']) == -1 ) {
            $("#plot_tab a:first").tab("show");
        }
    }
}

var scenario_db_id = {{ scenario_db_id }};

var scenario = {{ scenario | tojson }};

var lookup = {{ slider_lookup | tojson }};

var timeseries_available = {{ timeseries_available | tojson }};

var hubs = {{ hubs | tojson }};

var plot_tabs = {{ plot_tabs | tojson }};

var global_colors = {{ global_colors | tojson }};

var region_bar_plot = {{ region_bar_plot | tojson }};

scenario.children_dict = {};

scenario.children.forEach(function(data) {
    scenario.children_dict[data.name] = data;
});

makeAllAutomaticSlider();
makeIndividualBiomethanSilder();

plot_tabs.forEach(function(tab) {
    makeTab(tab.id, tab.label, tab.options, tab.content, tab.linkClass, tab.onclick, tab.active);
});

for (var element in lookup) {
    var l = lookup[element];
    if (getTagValue(element, l.value) != "null") {
        updateValue(element, getTagValue(element, l.value));
    }
}


var slider_changed = false;
var result_exists = false;
setResultExists(once=true);
updateDisabledPlotTabs();

// this is the main function which is executed when slider values change
$('#slider_form').change(function () {
    slider_changed = true;
    result_exists = false;
    updateDisabledPlotTabs();
    setSliderChangeInfo();
    if ($('.nav a.active')[0]['hash'] == "#input_overview") {
        renderInputOverview('input_overview');
    }

    renderInputOverview('input_overview');

    // RERENDER INPUT TIMESERIES PLOT
    if ($('.nav a.active')[0]['hash'] == "#input_timeseries_tab") {
        var edge = $("#input_timeseries_select_ts").val();
        var ts_obj = prepareTimeseries(edge);
        var type = $("#input_timeseries_select_type").val();
        renderTimeseriesSubPlot("input_timeseries", type, ts_obj);
    }

    if ($('.nav a.active')[0]['hash'] == "#input_stacked_tab") {
        //RERENDER INPUT STACKED TIMESERIES
        renderStackedInputSubPlot($("#input_stacked_select").val(), "input_stacked")
    }

});


renderInputOverview('input_overview');

// Hide button / info when landing on page for the first time
$('#sliderChangeInfo').hide();
$('#discardChanges').hide();
</script>
{% endblock %}
